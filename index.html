<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“å‰²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        .cell-active {
            background-color: #dcfce7;
            border-left: 4px solid #16a34a;
        }

        .conflict {
            background-color: #fee2e2;
            border-left: 4px solid #dc2626;
        }

        /* Custom scrollbar for table */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm;
            }

            body {
                background: white;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            /* Hide unnecessary elements */
            header,
            .md\:col-span-4,
            #tabContainer,
            .flex.gap-2.pb-1,
            .mt-4.p-4.bg-blue-50 {
                display: none !important;
            }

            /* Maximize Main Content */
            .max-w-7xl {
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .grid {
                display: block !important;
            }

            .md\:col-span-8 {
                width: 100% !important;
            }

            /* Table Styling for Print */
            .bg-white.rounded-b-2xl {
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
            }

            table {
                width: 100% !important;
                table-layout: fixed !important;
                border-collapse: collapse !important;
            }

            th,
            td {
                border: 1px solid #000 !important;
                color: #000 !important;
            }

            /* Ensure background colors print */
            .cell-active,
            .conflict {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                border: 1px solid #000 !important;
                /* Force border on cells */
            }

            /* Typography */
            .text-\[10px\] {
                font-size: 10pt !important;
                /* Increase font size */
            }

            .font-bold.truncate {
                font-size: 12pt !important;
                white-space: normal !important;
                /* Allow wrapping */
            }

            /* Hide Syllabus Link in Print */
            a[href*="syllabus"] {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 font-sans">

    <div class="max-w-7xl mx-auto p-4 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-slate-800">Timetable Simulator <span
                    class="text-sm font-normal text-slate-500">2025 Edition</span></h1>
            <p class="text-slate-600">è‡ªåˆ†ã ã‘ã®æ™‚é–“å‰²ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‚é¸æŠã—ãŸè¬›ç¾©ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 landscape:grid-cols-12 gap-8">
            <!-- Sidebar (Top on mobile portrait, Left on PC/Landscape) -->
            <div class="md:col-span-4 landscape:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-sm font-bold">æœŸé–“ã‚’é¸æŠ (è¤‡æ•°é¸æŠå¯)</label>
                        <label class="flex items-center cursor-pointer text-xs text-slate-600 hover:text-slate-800">
                            <input type="checkbox" id="strictModeToggle" class="mr-1 accent-blue-600"
                                onchange="toggleStrictMode()">
                            <span>å³å¯†ãƒ¢ãƒ¼ãƒ‰</span>
                        </label>
                    </div>

                    <!-- Term Filters (Multi-Select Toggles) -->
                    <div class="flex flex-wrap gap-2 mb-4" id="termButtons">
                        <button onclick="toggleSemester('å‰æœŸ')" data-term="å‰æœŸ"
                            class="term-btn px-3 py-1 rounded-full text-sm font-medium transition-colors border">å‰æœŸ</button>
                        <button onclick="toggleSemester('å¾ŒæœŸ')" data-term="å¾ŒæœŸ"
                            class="term-btn px-3 py-1 rounded-full text-sm font-medium transition-colors border">å¾ŒæœŸ</button>
                        <button onclick="toggleTerm('T1')" data-term="T1"
                            class="term-btn px-3 py-1 rounded-full text-sm font-medium transition-colors border">T1</button>
                        <button onclick="toggleTerm('T2')" data-term="T2"
                            class="term-btn px-3 py-1 rounded-full text-sm font-medium transition-colors border">T2</button>
                        <button onclick="toggleTerm('T3')" data-term="T3"
                            class="term-btn px-3 py-1 rounded-full text-sm font-medium transition-colors border">T3</button>
                        <button onclick="toggleTerm('T4')" data-term="T4"
                            class="term-btn px-3 py-1 rounded-full text-sm font-medium transition-colors border">T4</button>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold">è¬›ç¾©ã‚’æ¤œç´¢</label>
                        <button onclick="resetTimetable()"
                            class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded hover:bg-red-50 transition-colors">
                            ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                    <input type="text" id="searchInput" placeholder="ç§‘ç›®åã€æ•™å“¡åã§æ¤œç´¢..."
                        class="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4">

                    <!-- Advanced Filters -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <select id="deptFilter" class="p-2 border border-slate-300 rounded-lg text-sm">
                            <option value="">æ‰€å± (å…¨ã¦)</option>
                            <!-- Populated dynamically -->
                        </select>
                        <select id="gradeFilter" class="p-2 border border-slate-300 rounded-lg text-sm">
                            <option value="">å¹´æ¬¡ (å…¨ã¦)</option>
                            <option value="1">1å¹´</option>
                            <option value="2">2å¹´</option>
                            <option value="3">3å¹´</option>
                            <option value="4">4å¹´</option>
                            <option value="5">5å¹´</option>
                            <option value="6">6å¹´</option>
                        </select>
                        <select id="dayFilter" class="p-2 border border-slate-300 rounded-lg text-sm">
                            <option value="">æ›œæ—¥ (å…¨ã¦)</option>
                            <option value="1">æœˆ</option>
                            <option value="2">ç«</option>
                            <option value="3">æ°´</option>
                            <option value="4">æœ¨</option>
                            <option value="5">é‡‘</option>
                            <option value="6">åœŸ</option>
                        </select>
                        <select id="periodFilter" class="p-2 border border-slate-300 rounded-lg text-sm">
                            <option value="">æ™‚é™ (å…¨ã¦)</option>
                            <option value="1">1é™</option>
                            <option value="2">2é™</option>
                            <option value="3">3é™</option>
                            <option value="4">4é™</option>
                            <option value="5">5é™</option>
                            <option value="6">6é™</option>
                        </select>
                    </div>

                    <div id="resultsCount" class="text-xs text-slate-400 mb-2"></div>
                    <div id="searchResults" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                    </div>
                </div>
            </div>

            <!-- Main Content (Bottom on mobile portrait, Right on PC/Landscape) -->
            <div class="md:col-span-8 landscape:col-span-8">
                <!-- Tab Navigation -->
                <div class="flex justify-between items-end mb-0 border-b border-slate-200">
                    <div id="tabContainer" class="flex gap-2">
                        <!-- Tabs will be injected here -->
                    </div>
                    <div class="flex gap-2 pb-1">
                        <button onclick="generateShareUrl()"
                            class="text-xs flex items-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors"
                            title="URLã§å…±æœ‰">
                            <span>ğŸ”—</span> å…±æœ‰
                        </button>
                        <button onclick="printTimetable()"
                            class="text-xs flex items-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors"
                            title="å°åˆ· / PDFä¿å­˜">
                            <span>ï¿½ï¸</span> ä¿å­˜/å°åˆ· (PDF)
                        </button>
                    </div>
                </div>

                <!-- Added overflow-x-auto for horizontal scrolling on small screens -->
                <div
                    class="bg-white rounded-b-2xl rounded-tr-2xl shadow-sm border border-slate-200 overflow-x-auto border-t-0">
                    <table class="w-full min-w-[600px] table-fixed border-collapse">
                        <thead>
                            <tr class="bg-slate-100 border-b border-slate-200">
                                <th class="w-12 py-4"></th>
                                <th class="py-4 font-bold">æœˆ</th>
                                <th class="py-4 font-bold">ç«</th>
                                <th class="py-4 font-bold">æ°´</th>
                                <th class="py-4 font-bold">æœ¨</th>
                                <th class="py-4 font-bold">é‡‘</th>
                            </tr>
                        </thead>
                        <tbody id="timetableGrid">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-xl text-sm italic">
                    â€» é¸æŠã—ãŸè¬›ç¾©ãŒé‡ãªã£ã¦ã„ã‚‹å ´åˆã¯èµ¤ãè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
            </div>
        </div>
    </div>

    <script>
        let allLectures = [];
        // Data Structure: { plans: { "æ¡ˆ1": [], "æ¡ˆ2": [], "æ¡ˆ3": [] }, currentPlan: "æ¡ˆ1" }
        let timetableData = {
            plans: { "æ¡ˆ1": [], "æ¡ˆ2": [], "æ¡ˆ3": [] },
            currentPlan: "æ¡ˆ1"
        };

        // Migration & Initialization
        const savedData = localStorage.getItem('myTimetableData');
        if (savedData) {
            timetableData = JSON.parse(savedData);
        } else {
            // Migrate old data if exists
            const oldData = localStorage.getItem('myTimetable');
            if (oldData) {
                timetableData.plans["æ¡ˆ1"] = JSON.parse(oldData);
                localStorage.removeItem('myTimetable'); // Cleanup old key
            }
            saveData();
        }

        let activeTerms = ['T1']; // Default: T1 selected
        let isStrictMode = false;

        const timetableGrid = document.getElementById('timetableGrid');
        const searchResults = document.getElementById('searchResults');
        const searchInput = document.getElementById('searchInput');

        // Filters
        const deptFilter = document.getElementById('deptFilter');
        const gradeFilter = document.getElementById('gradeFilter');
        const dayFilter = document.getElementById('dayFilter');
        const periodFilter = document.getElementById('periodFilter');

        // Dept Code Map for Syllabus URL
        const deptCodeMap = {
            "æ–‡å­¦éƒ¨": "05",
            "æ•™è‚²å­¦éƒ¨": "07",
            "æ•™è‚²å­¦ç ”ç©¶ç§‘": "08",
            "æ³•å­¦éƒ¨": "15",
            "ç†å­¦éƒ¨": "22",
            "å·¥å­¦éƒ¨": "25",
            "æƒ…å ±èåˆå­¦ç’°": "26",
            "åŒ»å­¦éƒ¨": "42",
            "è–¬å­¦éƒ¨": "44",
            "ä¿å¥å­¦æ•™è‚²éƒ¨": "45",
            "è‡ªç„¶ç§‘å­¦æ•™è‚²éƒ¨": "51",
            "å¤šè¨€èªæ–‡åŒ–ç·åˆæ•™è‚²ã‚»ãƒ³ã‚¿ãƒ¼": "54",
            "ç¤¾ä¼šæ–‡åŒ–ç§‘å­¦æ•™è‚²éƒ¨": "56",
            "æ•™é¤Šæ•™è‚²": "58",
            "æ•™é¤Šæ•™è‚²ï¼ˆå¤§å­¦é™¢ï¼‰": "59",
            "åŒ»å­¦æ•™è‚²éƒ¨": "68",
            "è–¬å­¦æ•™è‚²éƒ¨": "69",
            "é¤Šè­·æ•™è«­ç‰¹åˆ¥åˆ¥ç§‘": "72",
            "ç‰¹åˆ¥æ”¯æ´æ•™è‚²ç‰¹åˆ¥å°‚æ”»ç§‘": "73"
        };

        // Term Mapping for Normalization
        const TERM_MAP = {
            'å‰æœŸ': ['T1', 'T2'],
            'å¾ŒæœŸ': ['T3', 'T4']
        };

        // åˆæœŸåŒ–ï¼šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        fetch('./data/lectures.json')
            .then(res => res.json())
            .then(data => {
                allLectures = data;
                initFilters();
                updateTermButtons(); // Initialize button styles

                // Check for shared plan in URL
                checkForSharedPlan();

                renderAll();
            })
            .catch(err => {
                console.error("Failed to load lecture data:", err);
                document.getElementById('timetableGrid').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-red-500 py-8 font-bold">
                            ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
                            <span class="text-sm font-normal text-slate-500">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ã‹ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</span>
                        </td>
                    </tr>
                `;
            });

        function saveData() {
            try {
                localStorage.setItem('myTimetableData', JSON.stringify(timetableData));
            } catch (e) {
                console.error("Failed to save data to localStorage:", e);
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®¹é‡ãŒä¸€æ¯ã‹ã€ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            }
        }

        function checkForSharedPlan() {
            const params = new URLSearchParams(window.location.search);
            const sharedPlanCompressed = params.get('plan');

            if (sharedPlanCompressed) {
                try {
                    const sharedPlan = decompressPlan(sharedPlanCompressed);
                    if (Array.isArray(sharedPlan) && confirm("å…±æœ‰ã•ã‚ŒãŸæ™‚é–“å‰²ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã€Œå…±æœ‰ã€ã‚¿ãƒ–ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n(æ—¢å­˜ã®ã€Œå…±æœ‰ã€ã‚¿ãƒ–ã®å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™)")) {
                        timetableData.plans["å…±æœ‰"] = sharedPlan;
                        timetableData.currentPlan = "å…±æœ‰";
                        saveData();
                        // Remove query param from URL without reload
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) {
                    console.error("Failed to parse shared plan", e);
                    alert("å…±æœ‰ã•ã‚ŒãŸæ™‚é–“å‰²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            }
        }

        function generateShareUrl() {
            const currentData = timetableData.plans[timetableData.currentPlan];
            if (!currentData || currentData.length === 0) {
                alert("å…±æœ‰ã™ã‚‹è¬›ç¾©ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            const compressed = compressPlan(currentData);
            const url = `${window.location.origin}${window.location.pathname}?plan=${compressed}`;

            navigator.clipboard.writeText(url).then(() => {
                alert("å…±æœ‰ç”¨URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
            }).catch(err => {
                console.error('Failed to copy: ', err);
                prompt("ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:", url);
            });
        }

        // --- Compression / Decompression Logic ---

        function compressPlan(lectureIds) {
            // 1. Map full IDs to short IDs: "å·¥å­¦éƒ¨_12345" -> "25:12345"
            const shortIds = lectureIds.map(id => {
                const [deptName, lectureId] = id.split('_');
                const deptCode = deptCodeMap[deptName];
                if (deptCode) {
                    return `${deptCode}:${lectureId}`;
                }
                return id; // Fallback if dept not found
            });

            // 2. Stringify and Compress
            const json = JSON.stringify(shortIds);
            return LZString.compressToEncodedURIComponent(json);
        }

        function decompressPlan(compressed) {
            // 1. Decompress
            const json = LZString.decompressFromEncodedURIComponent(compressed);
            if (!json) throw new Error("Decompression failed");

            const shortIds = JSON.parse(json);

            // 2. Map short IDs back to full IDs: "25:12345" -> "å·¥å­¦éƒ¨_12345"
            // Create reverse map for lookup
            const codeToDeptMap = Object.entries(deptCodeMap).reduce((acc, [name, code]) => {
                acc[code] = name;
                return acc;
            }, {});

            return shortIds.map(shortId => {
                if (shortId.includes(':')) {
                    const [code, id] = shortId.split(':');
                    const deptName = codeToDeptMap[code];
                    if (deptName) {
                        return `${deptName}_${id}`;
                    }
                }
                return shortId; // Fallback
            });
        }

        function printTimetable() {
            const originalTitle = document.title;
            const currentPlan = timetableData.currentPlan;
            document.title = `ã‚¯ãƒãƒ€ã‚¤æ™‚é–“å‰²_${currentPlan}_2025`;

            window.print();

            // Restore title after print dialog is closed
            // Note: onafterprint support varies, but is generally good in modern browsers
            window.onafterprint = () => {
                document.title = originalTitle;
                window.onafterprint = null; // Cleanup
            };

            // Fallback for browsers that don't block or support onafterprint well
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }

        // Alias for the button onclick (renaming the function in HTML would be cleaner but this works with minimal diff)
        // Actually, let's update the HTML onclick to printTimetable() for clarity.
        // Wait, I already updated the button text, let me update the onclick in the HTML chunk above? 
        // No, I missed updating the onclick in the previous chunk. I will do it here via a separate replace or just define downloadAsImage as printTimetable.
        // Better to rename properly. I will update the HTML onclick in a separate tool call or just map it here if I can't edit HTML again easily.
        // I can edit HTML. I'll update the onclick in the HTML chunk.
        // Ah, I see I didn't update the onclick in the HTML chunk above. I only updated the text.
        // Let me fix that in the HTML chunk if possible? No, I can't edit the previous chunk now.
        // I will just define downloadAsImage as printTimetable for now to ensure it works, 
        // OR I can issue another replace for the onclick.
        // Let's replace the function definition and also update the onclick in the HTML in a separate call if needed.
        // Actually, I can just replace the function name in the HTML in a separate chunk in this same call?
        // Yes, I can add another chunk for the onclick.

        // Defining the new function
        window.printTimetable = printTimetable;

        // Removing the old function
        // function downloadAsImage() { ... }

        function initFilters() {
            const depts = new Set();
            allLectures.forEach(l => {
                if (l.dept) depts.add(l.dept);
            });
            Array.from(depts).sort().forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                deptFilter.appendChild(option);
            });

            // Add event listeners for filters
            [deptFilter, gradeFilter, dayFilter, periodFilter].forEach(el => {
                el.addEventListener('change', handleSearch);
            });
        }

        function renderAll() {
            renderTabs();
            renderGrid();
            handleSearch();
        }

        function renderTabs() {
            const tabContainer = document.getElementById('tabContainer');
            if (!tabContainer) return;

            // Ensure "å…±æœ‰" exists in plans if it's the current plan or has data
            const allPlans = ["æ¡ˆ1", "æ¡ˆ2", "æ¡ˆ3"];
            if (timetableData.plans["å…±æœ‰"] || timetableData.currentPlan === "å…±æœ‰") {
                allPlans.push("å…±æœ‰");
                if (!timetableData.plans["å…±æœ‰"]) timetableData.plans["å…±æœ‰"] = [];
            }

            tabContainer.innerHTML = allPlans.map(plan => {
                const isActive = plan === timetableData.currentPlan;
                const count = timetableData.plans[plan] ? timetableData.plans[plan].length : 0;
                return `
                    <button onclick="switchTab('${plan}')" 
                        class="px-4 py-2 text-sm font-bold transition-colors border-b-4 ${isActive ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'}">
                        ${plan} <span class="text-xs font-normal ml-1 text-slate-400">(${count})</span>
                    </button>
                `;
            }).join('');
        }

        function switchTab(planName) {
            timetableData.currentPlan = planName;
            saveData();
            renderAll();
        }

        // ã‚°ãƒªãƒƒãƒ‰ï¼ˆæ™‚é–“å‰²ï¼‰ã®æç”»
        function renderGrid() {
            timetableGrid.innerHTML = '';
            const days = 5; // æœˆã€œé‡‘
            const slots = 5; // 1ã€œ5é™

            const currentSelectedIds = timetableData.plans[timetableData.currentPlan];

            for (let t = 1; t <= slots; t++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-center font-bold text-slate-400 border-b border-r border-slate-100">${t}</td>`;

                for (let d = 1; d <= days; d++) {
                    const td = document.createElement('td');
                    td.className = 'border-b border-r border-slate-100 p-1 h-24 vertical-top relative align-top';
                    td.id = `cell-${d}-${t}`;

                    // Flex container for cell content
                    const cellContent = document.createElement('div');
                    cellContent.className = 'flex flex-col gap-1 h-full overflow-hidden';
                    td.appendChild(cellContent);

                    // é¸æŠã•ã‚ŒãŸè¬›ç¾©ã‚’é…ç½® (Composite Key Check)
                    const matches = allLectures.filter(l =>
                        currentSelectedIds.includes(`${l.dept}_${l.id}`) &&
                        l.periods.some(p => p.day === d && p.time === t)
                    );

                    matches.forEach(m => {
                        const div = document.createElement('div');
                        div.className = `text-[10px] leading-tight p-1.5 rounded shadow-sm cursor-pointer flex-shrink-0 ${matches.length > 1 ? 'conflict' : 'cell-active'}`;
                        div.innerHTML = `
                            <div class="font-bold truncate">${m.title}</div>
                            <div class="truncate text-slate-600">${m.teacher ? m.teacher.split(',')[0] : ''}</div>
                            <a href="${getSyllabusUrl(m)}" target="_blank" onclick="event.stopPropagation()" class="text-blue-700 hover:underline block mt-0.5 font-bold text-[9px] text-right">ã‚·ãƒ©ãƒã‚¹ ></a>
                        `;
                        div.onclick = (e) => { e.stopPropagation(); toggleLecture(m.dept, m.id); };
                        cellContent.appendChild(div);
                    });

                    tr.appendChild(td);
                }
                timetableGrid.appendChild(tr);
            }
        }

        // æ¤œç´¢å‡¦ç† (Multi-Select Strict/Inclusive Filtering)
        function handleSearch() {
            const query = searchInput.value.toLowerCase();
            const deptVal = deptFilter.value;
            const gradeVal = gradeFilter.value;
            const dayVal = dayFilter.value;
            const periodVal = periodFilter.value;

            const currentSelectedIds = timetableData.plans[timetableData.currentPlan];

            // Prepare Effective Terms based on Mode
            // Note: Logic is now delegated to isTermMatch, but we still need effectiveTerms for Badge display if needed.
            // For Badge display, we can just use activeTerms and let the badge logic handle it, 
            // OR we can keep expanding it for the badge only.
            // Let's keep the expansion logic for the badge display consistency for now, 
            // but the filtering itself will use the robust isTermMatch.
            let displayTerms = [];
            if (isStrictMode) {
                displayTerms = [...activeTerms];
            } else {
                activeTerms.forEach(t => {
                    displayTerms.push(t);
                    if (TERM_MAP[t]) displayTerms.push(...TERM_MAP[t]);
                });
                displayTerms = [...new Set(displayTerms)];
            }


            // Filter Logic
            const filtered = allLectures.filter(l => {
                // 1. Period Check (Normalized Logic)
                if (activeTerms.length === 0) return false;
                if (!isTermMatch(l.tags, activeTerms, isStrictMode)) return false;

                // 2. Text Search (Partial match)
                const matchesQuery = query === '' ||
                    l.title.toLowerCase().includes(query) ||
                    (l.teacher && l.teacher.toLowerCase().includes(query));

                // 3. Attribute Filters
                const matchesDept = deptVal === '' || l.dept === deptVal;
                const matchesGrade = gradeVal === '' || l.grade == gradeVal;

                const matchesDayPeriod = (dayVal === '' && periodVal === '') ||
                    l.periods.some(p =>
                        (dayVal === '' || p.day == dayVal) &&
                        (periodVal === '' || p.time == periodVal)
                    );

                return matchesQuery && matchesDept && matchesGrade && matchesDayPeriod;
            }).slice(0, 50); // Limit to 50 for performance

            document.getElementById('resultsCount').innerText = `${filtered.length}ä»¶è¡¨ç¤ºä¸­`;

            if (filtered.length === 0) {
                searchResults.innerHTML = `<div class="text-center text-slate-400 py-8">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¬›ç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>`;
                return;
            }

            // Render Results
            searchResults.innerHTML = filtered.map(l => {
                const compositeKey = `${l.dept}_${l.id}`;
                const isSelected = currentSelectedIds.includes(compositeKey);
                const url = getSyllabusUrl(l);

                // Badge: Show the matching term(s) from displayTerms
                const matchingTags = l.tags ? l.tags.filter(t => displayTerms.includes(t)) : [];
                const badgeHtml = matchingTags.slice(0, 2).map(t =>
                    `<span class="inline-block bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full mr-1 mb-1 font-bold">${t}</span>`
                ).join('');

                return `
                <div onclick="toggleLecture('${l.dept}', '${l.id}')" 
                     class="p-3 border rounded-xl cursor-pointer transition-all duration-200 hover:border-blue-500 relative 
                     ${isSelected ? 'bg-blue-100 border-blue-500' : 'bg-white border-slate-200'}">
                    
                    ${isSelected ? '<span class="absolute top-2 right-2 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">è¿½åŠ æ¸ˆã¿</span>' : ''}
                    
                    <div class="mb-1">${badgeHtml}</div>
                    <div class="text-sm font-bold text-slate-800">${l.title}</div>
                    <div class="text-xs text-slate-500">${l.teacher || ''}</div>
                    <div class="text-xs text-slate-400 mt-1 flex gap-2 items-center">
                        <span>${l.dept || '-'}</span>
                        <span>${l.grade ? l.grade + 'å¹´' : '-'}</span>
                        <a href="${url}" target="_blank" onclick="event.stopPropagation()" class="text-blue-600 hover:underline ml-auto">ã‚·ãƒ©ãƒã‚¹ ></a>
                    </div>
                </div>
                `;
            }).join('');
        }

        // è¬›ç¾©ã®é¸æŠ/è§£é™¤ (Composite Key - Unified Signature)
        function toggleLecture(dept, id) {
            const compositeKey = `${dept}_${id}`;
            const currentPlan = timetableData.currentPlan;
            let currentSelectedIds = timetableData.plans[currentPlan];

            if (currentSelectedIds.includes(compositeKey)) {
                timetableData.plans[currentPlan] = currentSelectedIds.filter(k => k !== compositeKey);
            } else {
                timetableData.plans[currentPlan].push(compositeKey);
            }
            saveData();
            renderAll();
        }

        // Toggle Single Term (T1, T2, etc.)
        function toggleTerm(term) {
            if (activeTerms.includes(term)) {
                activeTerms = activeTerms.filter(t => t !== term);
            } else {
                activeTerms.push(term);
            }
            updateTermButtons();
            handleSearch();
        }

        // Toggle Semester (Direct Toggle)
        function toggleSemester(semester) {
            if (activeTerms.includes(semester)) {
                activeTerms = activeTerms.filter(t => t !== semester);
            } else {
                activeTerms.push(semester);
            }
            updateTermButtons();
            handleSearch();
        }

        function toggleStrictMode() {
            isStrictMode = document.getElementById('strictModeToggle').checked;
            handleSearch();
        }

        function resetTimetable() {
            if (confirm(`ã€Œ${timetableData.currentPlan}ã€ã®è¬›ç¾©ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                timetableData.plans[timetableData.currentPlan] = [];
                saveData();
                renderAll();
            }
        }

        function updateTermButtons() {
            const buttons = document.querySelectorAll('.term-btn');
            buttons.forEach(btn => {
                const term = btn.getAttribute('data-term');
                // Highlight ONLY if explicitly in activeTerms
                const isActive = activeTerms.includes(term);

                if (isActive) {
                    btn.className = 'term-btn px-3 py-1 rounded-full text-sm font-bold transition-all shadow-md bg-blue-600 text-white border-blue-600 transform scale-105';
                } else {
                    btn.className = 'term-btn px-3 py-1 rounded-full text-sm font-medium transition-colors border bg-slate-100 text-slate-400 border-slate-200 hover:bg-slate-200';
                }
            });
        }

        function getSyllabusUrl(lecture) {
            const deptCode = deptCodeMap[lecture.dept] || '26';
            return `https://syllabus.kumamoto-u.ac.jp/pub/syllabus.html?locale=ja&nendo=2025&jikanwari_shozokucd=${deptCode}&jikanwaricd=${lecture.id}`;
        }

        function isTermMatch(lectureTags, activeTerms, strictMode) {
            if (!lectureTags || lectureTags.length === 0) return false;

            if (strictMode) {
                // Strict Mode: Intersection of lectureTags and activeTerms
                return lectureTags.some(tag => activeTerms.includes(tag));
            } else {
                // Inclusive Mode:
                // If activeTerms includes 'å‰æœŸ', match if lectureTags has 'å‰æœŸ', 'T1', or 'T2'.
                // If activeTerms includes 'T1', match if lectureTags has 'T1' OR 'å‰æœŸ' (since T1 is part of å‰æœŸ).
                // Wait, the requirement says:
                // "activeTerms ã‚’ TERM_MAP ã§å±•é–‹ã—ãŸå¾Œã®é›†åˆã¨ã€lectureTags ã«å…±é€šè¦ç´ ãŒã‚ã‚‹ã‹"

                // Expand activeTerms
                const expandedActiveTerms = new Set();
                activeTerms.forEach(t => {
                    expandedActiveTerms.add(t);
                    if (TERM_MAP[t]) {
                        TERM_MAP[t].forEach(sub => expandedActiveTerms.add(sub));
                    }
                });

                // Also, if I select "T1", should it match "å‰æœŸ" tagged lectures?
                // Usually yes, because "å‰æœŸ" implies T1+T2.
                // But the previous logic was: expand 'å‰æœŸ' -> T1, T2.
                // If I select T1, it stays T1.
                // Lecture 'å‰æœŸ' has tag 'å‰æœŸ'. Intersection of [T1] and ['å‰æœŸ'] is empty.
                // So T1 selection didn't show 'å‰æœŸ' lectures in the old logic?
                // Let's check the old logic:
                // effectiveTerms = [T1]. lecture.tags = ['å‰æœŸ']. Intersection? No.

                // However, usually users expect T1 filter to show 'å‰æœŸ' lectures too?
                // The user prompt said: "activeTerms ã‚’ TERM_MAP ã§å±•é–‹ã—ãŸå¾Œã®é›†åˆã¨ã€lectureTags ã«å…±é€šè¦ç´ ãŒã‚ã‚‹ã‹"
                // So if I select 'å‰æœŸ', it expands to ['å‰æœŸ', 'T1', 'T2'].
                // Lecture with 'T1' matches. Lecture with 'å‰æœŸ' matches.

                // If I select 'T1', it expands to ['T1'].
                // Lecture with 'å‰æœŸ' (tags=['å‰æœŸ']) -> No match.
                // This seems to be the requested behavior ("Normalization").

                return lectureTags.some(tag => expandedActiveTerms.has(tag));
            }
        }

        searchInput.addEventListener('input', handleSearch);
    </script>

</body>

</html>